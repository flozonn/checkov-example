name: Checkov Wildcard Policy Detection

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  # Allow manual triggering
  workflow_dispatch:

jobs:
  checkov-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Checkov
      run: |
        pip install checkov
        
    - name: Run Checkov scan for wildcard policies
      id: checkov
      run: |
        # Run Checkov with built-in checks for wildcard policies
        checkov -d . \
          --framework terraform \
          --check CKV_AWS_60,CKV_AWS_61,CKV_AWS_62,CKV_AWS_63,CKV_AWS_40,CKV_AWS_39 \
          --output json \
          --soft-fail > checkov-results.json
        
        # Debug: Check if file was created correctly
        echo "Checking Checkov output file:"
        ls -la checkov-results.json || echo "File not found"
        if [ -f "checkov-results.json" ]; then
          echo "File size: $(wc -c < checkov-results.json) bytes"
          echo "First few lines:"
          head -5 checkov-results.json
        fi
          
    - name: Parse Checkov results and check for wildcards
      id: wildcard-check
      run: |
        python3 << 'EOF'
        import json
        import sys
        import os
        
        # Check if the file exists and is actually a file
        if not os.path.exists('checkov-results.json'):
            print("No Checkov results file found")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as output_file:
                output_file.write(f"violations_found=false\n")
            sys.exit(0)
            
        if os.path.isdir('checkov-results.json'):
            print("Error: checkov-results.json is a directory, not a file")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as output_file:
                output_file.write(f"violations_found=false\n")
            sys.exit(0)
        
        # Load Checkov results
        try:
            with open('checkov-results.json', 'r') as f:
                content = f.read().strip()
                if not content:
                    print("Checkov results file is empty")
                    with open(os.environ['GITHUB_OUTPUT'], 'a') as output_file:
                        output_file.write(f"violations_found=false\n")
                    sys.exit(0)
                results = json.loads(content)
        except (FileNotFoundError, json.JSONDecodeError) as e:
            print(f"Error reading Checkov results: {e}")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as output_file:
                output_file.write(f"violations_found=false\n")
            sys.exit(0)
        
        # Check for failed checks related to wildcards
        failed_checks = results.get('results', {}).get('failed_checks', [])
        wildcard_violations = []
        
        # Common wildcard-related check IDs (built into Checkov)
        wildcard_check_ids = [
            'CKV_AWS_60',  # IAM policy should not have * resource
            'CKV_AWS_61',  # IAM policy should not have * action
            'CKV_AWS_62',  # IAM role should not have * in trust policy
            'CKV_AWS_63',  # IAM policy attached to user/group/role should not have * action
            'CKV_AWS_40',  # IAM policy should not have * resource with PassRole action
            'CKV_AWS_39'   # IAM policy should not have * action and * resource
        ]
        
        for check in failed_checks:
            if check.get('check_id') in wildcard_check_ids:
                wildcard_violations.append({
                    'file': check.get('file_path', 'Unknown'),
                    'check_id': check.get('check_id'),
                    'check_name': check.get('check_name'),
                    'resource': check.get('resource', 'Unknown'),
                    'guideline': check.get('guideline', '')
                })
        
        # Set output for GitHub Actions using environment files
        if wildcard_violations:
            with open(os.environ['GITHUB_OUTPUT'], 'a') as output_file:
                output_file.write(f"violations_found=true\n")
                output_file.write(f"violation_count={len(wildcard_violations)}\n")
            
            # Create detailed message
            message = "ðŸš¨ **Wildcard Policy Violations Detected** ðŸš¨\\n\\n"
            for violation in wildcard_violations:
                message += f"- **File**: `{violation['file']}`\\n"
                message += f"  **Check**: {violation['check_id']} - {violation['check_name']}\\n"
                message += f"  **Resource**: `{violation['resource']}`\\n"
                if violation['guideline']:
                    message += f"  **Guideline**: {violation['guideline']}\\n"
                message += "\\n"
            
            # Write to environment file for multi-line output using proper delimiter
            delimiter = "VIOLATION_MESSAGE_EOF"
            with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                env_file.write(f"VIOLATION_MESSAGE<<{delimiter}\n{message}{delimiter}\n")
                
            print("Wildcard violations found!")
            for v in wildcard_violations:
                print(f"  - {v['file']}: {v['check_name']}")
        else:
            with open(os.environ['GITHUB_OUTPUT'], 'a') as output_file:
                output_file.write(f"violations_found=false\n")
            print("No wildcard policy violations detected.")
        EOF
        
    - name: Upload Checkov results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: checkov-results
        path: checkov-results.json
        
    - name: Comment on PR with violations
      if: github.event_name == 'pull_request' && steps.wildcard-check.outputs.violations_found == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const message = process.env.VIOLATION_MESSAGE;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
          
    - name: Fail workflow if violations found
      if: steps.wildcard-check.outputs.violations_found == 'true'
      run: |
        echo "âŒ Wildcard policy violations detected!"
        echo "Number of violations: ${{ steps.wildcard-check.outputs.violation_count }}"
        echo ""
        echo "Please review and fix the following issues:"
        echo "${{ env.VIOLATION_MESSAGE }}"
        exit 1
        
    - name: Success message
      if: steps.wildcard-check.outputs.violations_found == 'false'
      run: |
        echo "âœ… No wildcard policy violations detected!"
        echo "All IAM policies follow security best practices."